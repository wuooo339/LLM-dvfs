# LLM DVFS æµ‹è¯•é¡¹ç›®

è¿™ä¸ªé¡¹ç›®ç”¨äºæµ‹è¯•å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰åœ¨ä¸åŒé˜¶æ®µçš„åŠŸè€—å’Œæ€§èƒ½ï¼Œæ”¯æŒä¼ ç»Ÿå•å®ä¾‹å’Œåˆ†ç¦»å¼ Prefill+Decode ä¸¤ç§æ¶æ„çš„å¯¹æ¯”æµ‹è¯•ã€‚

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

### ä¼ ç»Ÿå•å®ä¾‹æ¶æ„
```
Client Request â†’ VLLM Server (Single Instance) â†’ Response
```

### åˆ†ç¦»å¼æ¶æ„
```
Client Request â†’ Proxy Server â†’ Prefill Instance (GPU 0) â†’ KV Transfer â†’ Decode Instance (GPU 1) â†’ Response
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
LLM-dvfs/
â”œâ”€â”€ gpu_monitor.py                    # GPU ç›‘æ§æ¨¡å—
â”œâ”€â”€ server/                           # VLLM æµ‹è¯•å¥—ä»¶
â”‚   â”œâ”€â”€ README.md                     # æµ‹è¯•å¥—ä»¶è¯´æ˜
â”‚   â”‚
â”‚   â”œâ”€â”€ traditional/                  # ä¼ ç»Ÿå•å®ä¾‹æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ start_vllm_server.sh      # å¯åŠ¨å•å®ä¾‹æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ test_vllm_server.py       # å•å®ä¾‹æµ‹è¯•è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ run_server_test.sh        # å•å®ä¾‹æµ‹è¯•è¿è¡Œè„šæœ¬
â”‚   â”‚   â”œâ”€â”€ analyze_server_results.py # å•å®ä¾‹ç»“æœåˆ†æ
â”‚   â”‚   â”œâ”€â”€ README_vllm_server.md     # å•å®ä¾‹æµ‹è¯•è¯´æ˜
â”‚   â”‚   â””â”€â”€ vllm_server_results/      # å•å®ä¾‹æµ‹è¯•ç»“æœ
â”‚   â”‚
â”‚   â”œâ”€â”€ disaggregated/                # åˆ†ç¦»å¼æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ start_disaggregated_servers.sh    # å¯åŠ¨åˆ†ç¦»å¼æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ disagg_prefill_proxy_server.py    # ä»£ç†æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ test_disaggregated_performance.py # åˆ†ç¦»å¼æµ‹è¯•è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ run_disaggregated_test.sh         # åˆ†ç¦»å¼æµ‹è¯•è¿è¡Œè„šæœ¬
â”‚   â”‚   â”œâ”€â”€ compare_performance.py            # æ€§èƒ½å¯¹æ¯”åˆ†æ
â”‚   â”‚   â”œâ”€â”€ README_disaggregated.md           # åˆ†ç¦»å¼æµ‹è¯•è¯´æ˜
â”‚   â”‚   â””â”€â”€ disaggregated_results/            # åˆ†ç¦»å¼æµ‹è¯•ç»“æœ
â”‚   â”‚
â”‚   â””â”€â”€ reference/                    # å®˜æ–¹å‚è€ƒæ–‡ä»¶
â”‚       â””â”€â”€ disaggregated_prefill.sh          # å®˜æ–¹åˆ†ç¦»å¼ç¤ºä¾‹
â”‚
â””â”€â”€ README.md                         # é¡¹ç›®è¯´æ˜ï¼ˆæœ¬æ–‡ä»¶ï¼‰
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### GPU ç›‘æ§ (`gpu_monitor.py`)
- **å®æ—¶ç›‘æ§**: GPU åŠŸè€—ã€é¢‘ç‡ã€åˆ©ç”¨ç‡ã€æ¸©åº¦
- **æ•°æ®ä¿å­˜**: æ”¯æŒ JSON æ ¼å¼ä¿å­˜å’Œç»Ÿè®¡åˆ†æ
- **å¯é…ç½®**: é‡‡æ ·é—´éš”ã€ç›‘æ§ GPU ç­‰å‚æ•°
- **å¤š GPU**: æ”¯æŒåŒæ—¶ç›‘æ§å¤šä¸ª GPU

### ä¼ ç»Ÿå•å®ä¾‹æµ‹è¯•
- **æ¨¡æ‹Ÿåˆ†ç¦»**: é€šè¿‡ `max_tokens` å‚æ•°æ¨¡æ‹Ÿ prefill å’Œ decode
- **åŠŸè€—åˆ†æ**: è¯¦ç»†çš„ GPU åŠŸè€—å’Œæ€§èƒ½åˆ†æ
- **ç»“æœå¯¹æ¯”**: ç”Ÿæˆæ€§èƒ½å¯¹æ¯”å›¾è¡¨å’ŒæŠ¥å‘Š

### åˆ†ç¦»å¼æµ‹è¯•
- **çœŸæ­£åˆ†ç¦»**: Prefill å’Œ Decode è¿è¡Œåœ¨ä¸åŒ GPU ä¸Š
- **KV ä¼ è¾“**: é€šè¿‡ P2P NCCL è¿›è¡Œé«˜é€Ÿç¼“å­˜ä¼ è¾“
- **ç²¾ç¡®æŒ‡æ ‡**: TTFTã€TBTã€E2E Latency æµ‹é‡
- **åŒ GPU ç›‘æ§**: åŒæ—¶ç›‘æ§ä¸¤ä¸ª GPU çš„å®æ—¶çŠ¶æ€

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šä¼ ç»Ÿå•å®ä¾‹æµ‹è¯•

```bash
# 1. å¯åŠ¨å•å®ä¾‹æœåŠ¡å™¨
cd server/traditional
./start_vllm_server.sh

# 2. è¿è¡Œæµ‹è¯•ï¼ˆæ–°ç»ˆç«¯ï¼‰
cd server/traditional
./run_server_test.sh

# 3. åˆ†æç»“æœ
python3 analyze_server_results.py
```

### æ–¹å¼äºŒï¼šåˆ†ç¦»å¼æµ‹è¯•

```bash
# 1. å¯åŠ¨åˆ†ç¦»å¼æœåŠ¡å™¨ï¼ˆéœ€è¦ 2 ä¸ª GPUï¼‰
cd server/disaggregated
./start_disaggregated_servers.sh

# 2. è¿è¡Œåˆ†ç¦»å¼æµ‹è¯•ï¼ˆæ–°ç»ˆç«¯ï¼‰
cd server/disaggregated
./run_disaggregated_test.sh

# 3. å¯¹æ¯”åˆ†æ
python3 compare_performance.py
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### ä¼ ç»Ÿæ–¹å¼æŒ‡æ ‡
- **Prefill æ—¶é—´**: å¤„ç†è¾“å…¥æç¤ºè¯çš„æ—¶é—´
- **Decode æ—¶é—´**: ç”Ÿæˆè¾“å‡º tokens çš„æ—¶é—´
- **æ€»æ—¶é—´**: å®Œæ•´çš„æ¨ç†æ—¶é—´
- **åŠŸè€—ç»Ÿè®¡**: å¹³å‡/æœ€å¤§åŠŸè€—ã€èƒ½è€—

### åˆ†ç¦»å¼æŒ‡æ ‡
- **TTFT (Time to First Token)**: é¦– token æ—¶é—´
- **TBT (Time Between Tokens)**: token é—´æ—¶é—´
- **E2E Latency**: ç«¯åˆ°ç«¯å»¶è¿Ÿ
- **KV ä¼ è¾“æ—¶é—´**: ç¼“å­˜ä¼ è¾“è€—æ—¶
- **åŒ GPU åŠŸè€—**: åˆ†åˆ«ç›‘æ§ä¸¤ä¸ª GPU

## ğŸ“ˆ è¾“å‡ºç»“æœ

### ä¼ ç»Ÿå•å®ä¾‹ç»“æœ
- `server/traditional/vllm_server_results/prefill_results.json` - Prefill é˜¶æ®µç»“æœ
- `server/traditional/vllm_server_results/decode_results.json` - Decode é˜¶æ®µç»“æœ
- `server/traditional/vllm_server_results/vllm_server_comparison.png` - æ€§èƒ½å¯¹æ¯”å›¾è¡¨

### åˆ†ç¦»å¼ç»“æœ
- `server/disaggregated/disaggregated_results/disaggregated_results.json` - å®Œæ•´æµ‹è¯•ç»“æœ
- `server/disaggregated/disaggregated_results/prefill_gpu_data.json` - Prefill GPU ç›‘æ§æ•°æ®
- `server/disaggregated/disaggregated_results/decode_gpu_data.json` - Decode GPU ç›‘æ§æ•°æ®
- `server/disaggregated/disaggregated_results/disaggregated_performance_analysis.png` - è¯¦ç»†æ€§èƒ½åˆ†æå›¾è¡¨

### å¯¹æ¯”åˆ†æç»“æœ
- `server/disaggregated/performance_comparison.png` - ä¼ ç»Ÿ vs åˆ†ç¦»å¼æ€§èƒ½å¯¹æ¯”å›¾

## ğŸ”§ æŠ€æœ¯ç‰¹ç‚¹

### åŠŸè€—ç›‘æ§
- **é‡‡æ ·é¢‘ç‡**: 100ms é«˜ç²¾åº¦é‡‡æ ·
- **ç›‘æ§æŒ‡æ ‡**: åŠŸè€—ã€é¢‘ç‡ã€åˆ©ç”¨ç‡ã€æ¸©åº¦
- **æ•°æ®æº**: ç›´æ¥ä½¿ç”¨ nvidia-smi ç¡¬ä»¶ä¼ æ„Ÿå™¨
- **å¯è§†åŒ–**: å®æ—¶åŠŸè€—å˜åŒ–æ›²çº¿å›¾

### åˆ†ç¦»å¼æ¶æ„
- **ç‰©ç†åˆ†ç¦»**: Prefill å’Œ Decode è¿è¡Œåœ¨ä¸åŒ GPU
- **KV ä¼ è¾“**: P2P NCCL é«˜é€Ÿç¼“å­˜ä¼ è¾“
- **ä»£ç†æœåŠ¡**: è‡ªåŠ¨å¤„ç†è¯·æ±‚è½¬å‘å’Œç»“æœåˆå¹¶
- **èµ„æºéš”ç¦»**: ç‹¬ç«‹çš„ GPU èµ„æºç®¡ç†

### æ€§èƒ½åˆ†æ
- **æ—¶é—´ç²¾åº¦**: å¾®ç§’çº§æ—¶é—´æµ‹é‡
- **å¤šç»´åº¦**: æ—¶é—´ã€åŠŸè€—ã€é¢‘ç‡ã€åˆ©ç”¨ç‡
- **å¯¹æ¯”åˆ†æ**: ä¼ ç»Ÿ vs åˆ†ç¦»å¼æ¶æ„å¯¹æ¯”
- **å¯è§†åŒ–**: ä¸°å¯Œçš„å›¾è¡¨å’Œç»Ÿè®¡åˆ†æ

## ğŸ“‹ ä¾èµ–è¦æ±‚

### åŸºç¡€ä¾èµ–
- Python 3.8+
- VLLM 0.10.2+
- PyTorch
- matplotlib
- requests
- numpy

### åˆ†ç¦»å¼æµ‹è¯•é¢å¤–ä¾èµ–
- Quart (ä»£ç†æœåŠ¡å™¨)
- aiohttp (å¼‚æ­¥ HTTP å®¢æˆ·ç«¯)
- è‡³å°‘ 2 ä¸ª GPU
- P2P é€šä¿¡æ”¯æŒ (NVLink æˆ– PCIe)

### ç³»ç»Ÿè¦æ±‚
- nvidia-smi (GPU ç›‘æ§)
- CUDA é©±åŠ¨
- è¶³å¤Ÿçš„ GPU å†…å­˜

## âš ï¸ æ³¨æ„äº‹é¡¹

### ç¡¬ä»¶è¦æ±‚
- **ä¼ ç»Ÿæµ‹è¯•**: 1 ä¸ª GPUï¼Œ8GB+ æ˜¾å­˜
- **åˆ†ç¦»å¼æµ‹è¯•**: 2 ä¸ª GPUï¼Œæ¯ä¸ª 8GB+ æ˜¾å­˜
- **P2P é€šä¿¡**: GPU é—´éœ€è¦æ”¯æŒ P2P é€šä¿¡

### è½¯ä»¶é…ç½®
- ç¡®ä¿ VLLM ç‰ˆæœ¬å…¼å®¹
- æ£€æŸ¥ GPU é©±åŠ¨å’Œ CUDA ç‰ˆæœ¬
- éªŒè¯æ¨¡å‹è·¯å¾„å’Œæƒé™

### æ€§èƒ½ä¼˜åŒ–
- æµ‹è¯•æœŸé—´å…³é—­å…¶ä»– GPU å¯†é›†å‹åº”ç”¨
- æ ¹æ®ç¡¬ä»¶è°ƒæ•´ GPU å†…å­˜åˆ©ç”¨ç‡
- ä¼˜åŒ– KV ä¼ è¾“è·¯å¾„ (åŒ NVLink ç»„)

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **CUDA å¤šè¿›ç¨‹é”™è¯¯**: å·²é€šè¿‡è®¾ç½® `spawn` æ¨¡å¼è§£å†³
2. **ç«¯å£å†²çª**: æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ
3. **GPU å†…å­˜ä¸è¶³**: è°ƒæ•´ `gpu_memory_utilization` å‚æ•°
4. **KV ä¼ è¾“å¤±è´¥**: æ£€æŸ¥ GPU é—´ P2P è¿æ¥

### è°ƒè¯•æ–¹æ³•
- æŸ¥çœ‹æœåŠ¡å™¨å¯åŠ¨æ—¥å¿—
- æ£€æŸ¥ GPU çŠ¶æ€: `nvidia-smi`
- éªŒè¯ç½‘ç»œè¿æ¥: `curl localhost:8000/health`
- æŸ¥çœ‹ä»£ç†æœåŠ¡å™¨æ—¥å¿—

## ğŸ“š æ‰©å±•åŠŸèƒ½

### æ‰¹é‡æµ‹è¯•
- æ”¯æŒå¹¶å‘è¯·æ±‚æµ‹è¯•
- æ‰¹é‡æ€§èƒ½åˆ†æ
- è´Ÿè½½å‡è¡¡æµ‹è¯•

### ä¸åŒæ¨¡å‹å¯¹æ¯”
- æ”¯æŒå¤šç§æ¨¡å‹æµ‹è¯•
- æ¨¡å‹æ€§èƒ½å¯¹æ¯”åˆ†æ
- é…ç½®å‚æ•°ä¼˜åŒ–

### è·¨èŠ‚ç‚¹éƒ¨ç½²
- æ”¯æŒè·¨æœºå™¨åˆ†ç¦»å¼éƒ¨ç½²
- ç½‘ç»œå¸¦å®½ä¼˜åŒ–
- åˆ†å¸ƒå¼æ€§èƒ½åˆ†æ

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº MIT è®¸å¯è¯å¼€æºã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›é¡¹ç›®ï¼